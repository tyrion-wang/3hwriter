<!DOCTYPE html>
<html lang="en">
<head>
    <title>AI Writer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

{#############################################}
<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML"></script>
<div class="content1">
</div>
<div class="input-area">
    <textarea name="text" id="textarea1">写一篇2000字的作文</textarea>
    <div class="button-area">
        <button id="send-btn1" class="talk_sub">发 送</button>
        <button id="stop-btn1" class="talk_sub">停 止</button>
    </div>
</div>

<script type="text/javascript" charset="utf-8">
    let returnMessageAjax = null;
    $("#stop-btn1").hide();
    $("#send-btn1").click(function () {
        console.log("click")
        var text = $("#textarea1").val();
        console.log(text);
        if (text == "") {
            alert("请输入内容");
            return;
        }
        let html = ''
        html += '<div class="item item-right"><div class="bubble bubble-right markdown">' + marked.marked(text) + '</div></div>';
        $(".content1").append(html);
        $("#textarea1").val("");
        $(".content1").scrollTop($(".content1")[0].scrollHeight);
        let chat_item = $('<div class="item item-left"><div class="bubble bubble-left markdown">正在等待回复</div></div>')
        $(".content1").append(chat_item);
        $(".content1").scrollTop($(".content1")[0].scrollHeight);
        let get_times = 0;
        returnMessageAjax = $.ajax({
            url: "/returnMessage1",
            data: {
                "send_message": text,
            },
            type: "Post",
            dataType: "json",
            xhrFields: {
                onprogress: function (e) {
                    let response = e.currentTarget.response;
                    if (response.startsWith("url_redirect:")){
                        window.location.href=response.split(":")[1];
                    } else {
                        get_times += 1;
                        if (get_times === 2) {
                            $("#stop-btn1").show();
                        }
                        let div =  document.createElement('div');
                        div.innerHTML = marked.marked(response);
                        MathJax.Hub.Typeset(div);
                        chat_item.find(".bubble").empty();
                        chat_item.find(".bubble").append(div);
                        $(".content1").scrollTop($(".content1")[0].scrollHeight);
                    }
                },
                onload: function (e) {
                    $("#stop-btn1").hide();
                }
            },
            timeout: 1000 * 60 * 2,
            complete: function (XMLHttpRequest, status) {
                if (status === 'timeout') {
                    alert("请求超时");
                }
                $("#stop-btn1").hide();
                let btn = $("<span class=\"code-copy-btn\" onclick='codeCopy(this)'>复制代码</span>");
                btn.prependTo(chat_item.find(".bubble").find("pre"));
            }
        });
    });

    $("#stop-btn1").click(function (){
        // 停止returnMessage请求
        if (returnMessageAjax != null) {

            returnMessageAjax.abort();
            returnMessageAjax = null;
        }
        $("#stop-btn1").hide();
    });
</script>

</body>
</html>